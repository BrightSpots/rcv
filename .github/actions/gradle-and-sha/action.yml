name: Run gradle command and create SHA512

inputs:
  build-keychain-password:
    required: false
    type: string
  gradle-command:
    required: true
    type: string
  intermediate-filepath:
    required: true
    type: string
  final-filepath:
    required: true
    type: string

runs:
  using: "composite"
  steps:
    - name: "Run gradle command"
      shell: bash
      run: |
        if [ $(which security) ] && [ "${{ inputs.build-keychain-password }}" != "" ]; then
          echo "Unlocking keychain"
          security default-keychain -s build.keychain
          security unlock-keychain -p ${{ inputs.build-keychain-password }} build.keychain
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k ${{ inputs.build-keychain-password }} build.keychain
        fi
        ./gradlew ${{ inputs.gradle-command }}

    - name: "Rename output file"
      shell: bash
      run: mv ${{ inputs.intermediate-filepath }} ${{ inputs.final-filepath }}

    - name: "Generate SHA512 for Linux"
      shell: bash
      if: runner.os == 'Linux'
      run: sha512sum ${{ inputs.final-filepath }} > ${{ inputs.final-filepath }}.sha512
    - name: "Generate SHA512 for Windows"
      shell: bash
      if: runner.os == 'Windows'
      run: certutil -hashfile ${{ inputs.final-filepath }} SHA512 >> ${{ inputs.final-filepath }}.sha512
    - name: "Generate SHA512 for OSX"
      shell: bash
      if: runner.os == 'macOS'
      run: openssl dgst -sha512 > ${{ inputs.final-filepath }}.sha512
